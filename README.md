# Secure Attested PCR Machine

The Secure Attested PCR Machine is a modified ThermoFisher Scientific 7500 Fast real-time PCR system that incorporates tamper-proof result attestation. By integrating a Zymbit secure element, the machine cryptographically signs all test results, ensuring their authenticity and preventing manipulation. The system is designed for use in supervised laboratory environments where sample chain of custody is maintained.

Key security features include:
- Cryptographic signing of all test results via the Zymbit secure element
- Tamper-evident resin seals on all connections and access points
- Any attempts to open or modify the machine result in visible damage to security seals
- Secure boot and runtime attestation of the control software

## How Do I Build The Raspberry Pi Image?

There's a [Taskfile](https://taskfile.dev) in this repository that you can use to run the update scripts locally.

  - Install [Taskfile](https://taskfile.dev/installation/)
  - Install [Docker](https://www.docker.com/)
  - Create a `workspace` directory and place your `input.img` in that
  - Run `task build`

Alternatively, you can also manually run `docker`:
```
docker run --rm --privileged -v $(pwd)/workspace:/CustoPiZer/workspace $(pwd)/zymbit_image/scripts:/CustoPiZer/workspace/scripts ghcr.io/octoprint/custopizer:latest
```


## System Architecture

This system addresses a fundamental challenge in digital laboratory equipment: how do we ensure that test results haven't been falsified or tampered with?

### Core Security Model

There is a one-way flow of information:

`[PCR Machine] → [Sealed VM Environment] → [Virtual Serial] → [Host System]`

This entire chain of execution occurs in tamper-evident environment.

The integrity of the environment is guaranteed by tamper-evident seals on all connections, and the use of Secure Boot within the Zymbit.

### Data Flow Pipeline

1. **Generation**  
   - PCR tests run within the isolated Windows XP VM
   - Results are generated by unmodified ThermoFisher software
   - The OS is locked-down, has no network access and can't install additional software
   - We're assuming that, in this heavily locked-down setting, the user has no ability to tamper with the results

2. **Transport**  
   - The VM may forward results to the host system via a virtual serial channel
   - The channel is unidirectional: data can only flow out of the VM
   - The data is stored securely in the host, within a protected directory
   - We make use of cgroups and other isolation mechanisms to keep this safe

3. **Attestation**  
   - The host's attestation daemon (`attestation_daemon.py`) receives results
   - Each result is immediately signed (soon using the Zymbit secure element)
   - Signatures are created using Ed25519 public-key cryptography
   - The private key will never the hardware security module

4. **Storage & Access**  
   - Signed results and their signatures are stored in a protected directory
   - Files can only be added, never modified or deleted
   - Results can be verified using the system's public key
   - Access is provided through the read-only SSH account

### Guaranteeing Integrity

1. **Physical Security**  
   The PCR machine and Zymbit module are physically sealed with tamper-evident resin. Any attempt to modify the hardware or inject false signals leaves visible evidence.

2. **Virtualization Barrier**  
   The PCR software runs in a pristine Windows XP environment that:
   - Resets to a known-good state on every boot via Windows SteadyState
   - Has no network access or ability to install additional software
   - Can only communicate results through a single, monitored virtual serial channel
   - Is accessible only through SPICE protocol for direct operation

3. **Cryptographic Attestation**  
   Results follow a one-way path:
   - Generated by the PCR software
   - Transmitted via virtual serial to the host
   - Immediately signed using the Zymbit hardware security module
   - Stored in a write-once, read-many directory

### Access Control

The system enforces strict role separation through three highly-restricted user accounts:

- **SPICE Access** (`7500Fast`)  
  Allows operators to run tests by tunneling the SPICE protocol over SSH. This account:
  - Has no shell access
  - Can only forward the SPICE port
  - Requires key-based authentication

- **Results Reader** (`result_reader`)  
  Provides secure access to signed results via SSH. This account:
  - Has read-only access to the results directory
  - Cannot modify or delete existing results
  - Requires key-based authentication

- **WiFi Configuration** (`wifi_setup`)  
  Allows network setup through a restricted interface. This account:
  - Has no password
  - Can only run the `nmtui` network configuration tool
  - Cannot access any other system functions

## The Codebase

```
├── README.md                           
├── Taskfile.yml                        # Build Automation
├── access-ui.sh                        # Use This To Connect To The Machine!!
│
├── 7500FastXP/                         # Windows XP VM componentsv
│   ├── HOW.md                          # Documentation
│   └── service.py                      # Windows Service For Transferring Results To Host For Signing
│
├── zymbit_image/                       # Raspbian Image Customization
│   └── scripts/                        
│       ├── 00-prelude.sh               # System Hardening
│       ├── 01-tailscale.sh             # VPN Setup
│       ├── 02-qemu.sh                  # VM Environment Setup
│       ├── 03-7500FastXP.sh            # VM Deployment
│       ├── 04-attestation_daemon.sh    # Result Signing Service Setup
│       ├── 05-create_users.sh          # User Management
│       ├── 06-clear_apt_cache.sh       # Cleanup
│       └── files/                      # Configuration files
│           ├── attestation_daemon.py   # Result Signing Daemon
│           └── vm/                     # VM Configuration Files
│               ├── 7500FastXP.xml      # VM Definition
│               └── 7500FastXP          # VM Disk Image
│
└── patch_over_ssh/                     # Remote Management Tools
    ├── add-auto-configure-to-zymbit.sh # Remote Setup Script
    ├── harden-ssh-zymbit.sh            # SSH Security Configuration
    └── script.py                       # Remote Configuration Utility
```
